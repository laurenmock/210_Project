---
title: 'BST 210 Project: Check-In 2'
author: "Daniel Herrera, Willow Duffell, Lauren Mock"
date: "11/6/2021"
output:
  html_document:
    df_print: paged
  pdf_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### *Group 4 Members:* 

Daniel Herrera  
Willow Duffell  
Lauren Mock

```{r, warning=FALSE, include=FALSE}
library(tidyverse)
library(caret)
library(rpart)
library(rpart.plot)

bone <- read.csv("data.csv")

# remove HLA_match_raw (was already converted into a different column)
bone <- select(bone, -HLA_match_raw)

# convert numeric columns to numeric
bone_num <- c("donor_age", "recipient_age", "recipient_body_mass", "CD34_x1e6_per_kg...CD34kgx10d6",
           "CD3_x1e8_per_kg", "CD3_to_CD34_ratio", "ANC_recovery", "PLT_recovery",
           "time_to_acute_GvHD_III_IV", "survival_time", "survival_status")

bone[,bone_num] <- lapply(bone_num, function(x) as.numeric(bone[[x]]))
```


# Logistic regression to predict survival

We want to predict the probability of survival after transplantation, given known covariates that can be measured before transplantation. 

*question: what determines dosage amount? so should we include this as a predictor or not?*

```{r}
# remove variables that are measured after transplantation
predictors <- bone[,c(1:24,37)] # selects only predictors and survival (the outcome)

# logistic model with all covariates
mod_all_vars <- glm(survival_status ~ ., family = binomial(), data = predictors)
summary(mod_all_vars)

p_hats <- mod_all_vars$fitted.values
head(p_hats)



# only predicts 2 values, not sure why...

# regardless, we will definitely need to select some variables that make sense

```


## Variables related to the donor

```{r}
# variables related to the donor
mod_donor <- glm(survival_status ~ donor_age + donor_age_below_35 + donor_ABO + donor_CMV, 
            family = binomial(), data = predictors)

head(mod_donor$fitted.values)
```

We can then decide to remove the variable for donor_age_below_35 because of multicolineary. Including this variable will not allow us to properly "hold other variables constant" since the variable age modifies this variable of age_below_35. 

We see here that our predictors are pretty bad, even on a testing only dataset.

```{r}
mod_donor <- glm(survival_status ~ donor_age + donor_ABO + donor_CMV, 
            family = binomial(), data = predictors)
summary(mod_donor)

prediction <- ifelse(mod_donor$fitted.values > 0.5, 1, 0) 
confusionMatrix(data = as.factor(prediction), 
                reference = as.factor(predictors$survival_status),
                positive = "1")
```
 


## Variables related to the recipient

Here we have to deal with the issue of having missing values for the variable recipient_body_mass.
We elect to remove the variables here since only two values are missing and a sample of 185 should be sufficient. 

We can later choose to explore these cases individually to assess if there was any particular reason that these cases should be explored further. 

Our model here is not great, an accuracy of 64.32%. It does not have a balanced sensitivity versus specificity and is actually better at predicting those among the population with outcome of 1, death. This may be to our benefit though, as we would really like to know, of those who died, how many are we predicting death. 


```{r}
#create subset of data with no missing values, ie remove 2 missing bmi
recip_complete <- predictors %>% 
  select(c(survival_status, recipient_age, recipient_gender, recipient_body_mass,
           recipient_ABO, recipient_rh, recipient_CMV)) %>% 
  drop_na()

mod_recip <- glm(survival_status ~ recipient_age + recipient_gender + recipient_body_mass +
                   recipient_ABO + as.factor(recipient_rh) + as.factor(recipient_CMV), 
            family = binomial(), data = recip_complete)
summary(mod_recip)
prediction <- ifelse(mod_recip$fitted.values > 0.5, 1, 0) 
confusionMatrix(data = as.factor(prediction), 
                reference = as.factor(recip_complete$survival_status),
                positive = "1")


mod_disease <- glm(survival_status ~ disease + disease_group, 
            family = binomial(), data = predictors)
summary(mod_disease)

```

Since disease_group and disease have overlap in the shared malignant level, we will select only one. Here we find an accuracy of 59.36% and no statistically significant predictor variables. 

```{r}
mod_disease <- glm(survival_status ~ disease , 
            family = binomial(), data = predictors)
summary(mod_disease)

prediction <- ifelse(mod_disease$fitted.values > 0.5, 1, 0) 
confusionMatrix(data = as.factor(prediction),
                reference = as.factor(predictors$survival_status),
                positive = "1")
```



## Variables related to the closeness of the match

Per our medical expert, not specifically domain expert, the suggestion is to not include HLA Match AND antigen/allele. In this case we will choose to only choose the variable HLA Match out of 10. 

We see again here that our model is pretty ineffective as detecting survival status with an accuracy of 58.82%. 

```{r}
mod_match <- glm(survival_status ~ gender_match + ABO_match + CMV_status + HLA_match..out.of.10. + 
            antigen + allele,
            family = binomial(), data = predictors)
summary(mod_match)
p_hats <- mod_match$fitted.values
head(p_hats, 30)
mean(p_hats)

# looks like something weird is happening with antigen (very bad predictor of survival)

# when we remove antigen, it looks pretty normal
# we can explore it without antigen or allele
mod_match <- glm(survival_status ~ gender_match + ABO_match + CMV_status + HLA_match..out.of.10.,
            family = binomial(), data = predictors)
summary(mod_match)
prediction <- ifelse(mod_match$fitted.values > 0.5, 1, 0) 
confusionMatrix(data = as.factor(prediction), 
                reference = as.factor(predictors$survival_status),
                positive = "1")

```


## Variables related to stem cell source

Again, we are seeing that are model is not doing to well in terms of accuracy of prediction. However, the model for stem cell source is doing well in terms of sensitivity, unfortunately this is offset by its specificity. 

```{r}
mod_source <- glm(survival_status ~ stem_cell_source, 
            family = binomial(), data = predictors)
summary(mod_source)



prediction <- ifelse(mod_source$fitted.values > 0.5, 1, 0)

confusionMatrix(data = as.factor(prediction), 
                reference = as.factor(predictors$survival_status),
                positive = "1")

```


This all lead me to wonder why our predictions are so subpar. Perhaps we should look at the prevalence of death?

We see that there are a reasonable amount who survived and died indicating there is not a substantial imbalance which we would need to consider. 

```{r}
bone %>% 
  count(survival_status)
```


Below we will try again with a more "full" model now that we have parsed out some variables due to concerns of collinearity due to variables measuring the same or similar metrics. 
We remove variables included in recipient and donor that can be summarized by '..._match" variables.

Our model here has an accuracy of 65.41%


```{r}
# attempt at a similar "full model"

#find complete cases only
cases_comp <- predictors %>% 
  select(c(survival_status, recipient_age, recipient_gender, recipient_body_mass,
           recipient_ABO, recipient_rh, recipient_CMV, donor_age, stem_cell_source, disease, gender_match, ABO_match, CMV_status, stem_cell_source)) %>%
  drop_na()


full_mod <- glm(survival_status ~ donor_age  + stem_cell_source + recipient_age  + recipient_body_mass + as.factor(recipient_rh) + disease + gender_match + ABO_match + CMV_status + stem_cell_source, 
                family = binomial(), 
                data = cases_comp)

summary(full_mod)
prediction <- ifelse(full_mod$fitted.values > 0.5, 1, 0) 
confusionMatrix(data = as.factor(prediction), 
                reference = as.factor(cases_comp$survival_status),
                positive = "1")
```


We can try to use forward selection here: 
```{r}
library(broom)

cases_comp <- cases_comp %>% 
  select(c(survival_status, recipient_age, recipient_body_mass,
           recipient_rh, disease, donor_age, stem_cell_source, disease, gender_match, ABO_match, CMV_status))

mod_basic <- glm(survival_status ~ 1, data=cases_comp, family = "binomial")
stepModel <- step(mod_basic, direction="forward",
                  scope=(~ donor_age  + stem_cell_source + recipient_age  + recipient_body_mass + as.factor(recipient_rh) + disease + gender_match + ABO_match + CMV_status + stem_cell_source),
                  data=cases_comp)

tidy(stepModel)
```

Using forward selection, we are given the following model:

survival_status ~ recipient_body_mass + disease + as.factor(recipient_rh) + stem_cell_source
With an AIC of 239.57



Next, we can try backwards selection:
```{r}
mod_back <- glm(survival_status ~ donor_age  + stem_cell_source + recipient_age  + recipient_body_mass + as.factor(recipient_rh) + disease + gender_match + ABO_match + CMV_status + stem_cell_source, 
                data = cases_comp, 
                family = "binomial")

backStepModel <- step(mod_back, 
                      direction = "backward",
                      data = cases_comp)

tidy(backStepModel)
```

With this model selection method, we are given the following model:

survival_status ~ stem_cell_source + recipient_body_mass + as.factor(recipient_rh) + disease
With an AIC value of 239.57


So, whether we use the forward or backwards selection process, we are given the same model. 


Summary statistics of this model are given below:

Here we see that this model gives an overall accuracy of 66% (getting a little better) with sensitivity of 45.7% and specificity of 82.4%. Still, we are not classifying deaths with a very high success rate (yet!)
```{r}
mod.result <- glm(survival_status ~ stem_cell_source + recipient_body_mass + as.factor(recipient_rh) + disease,
                  data = cases_comp,
                  family = binomial())
summary(mod.result)


prediction <- ifelse(mod.result$fitted.values > 0.45, 1, 0) # Changed the cutoff to get better results for sensitivity, lowers overall accuracy though


confusionMatrix(data = as.factor(prediction), 
                reference = as.factor(cases_comp$survival_status),
                positive = "1")
```


Are biggest issue seems to be our sensitivity, or having our model correctly predict a case of death. Let's see where the max possible sensitivity could be based on our current predictive model based on an ROC curve and the area under the curve.

```{r}
library(pROC)

roc_logit <- roc(cases_comp$survival_status, mod.result$fitted.values)

ggroc(list("Logistic" = roc_logit)) +
  theme(legend.title = element_blank()) +
  geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color = "black", linetype = "dashed") +
  xlab("Specificity") +
  ylab("Sensitivity") +
  ggtitle("ROC Curve")

auc(roc_logit) # Want this to be >0.7
```



Next we can try decision trees. We see here that the predictive accuracy is much higher now! We have an accuracy of 77.3% and a balanced sensitivity and specificity. 

```{r}
cases_comp <- cases_comp %>% 
  select(c(survival_status, recipient_age, recipient_body_mass,
           recipient_rh, disease, donor_age, stem_cell_source, disease, gender_match, ABO_match, CMV_status))



# will fit the tree 
fit <- rpart(as.factor(survival_status) ~ ., data = cases_comp)

# will plot the tree 
rpart.plot(fit, cex = 0.5)

# create new dataframe without survival outcomes
df <- subset(cases_comp, select = -c(survival_status))

#make predicitons and cutoffs
mypreds <- predict(fit, df)
predictions <- ifelse(mypreds[,2] > 0.5, 1, 0)


confusionMatrix(data = as.factor(predictions), 
                reference = as.factor(cases_comp$survival_status),
                positive = "1")

```




# Secondary Analysis

We can also look at some secondary analyses. We read a journal article that found that patients who received peripheral stem cell transplants were more likely to develop graft-versus-host disease (GVHD). We can easily check to see if this holds true in our data.

```{r}
# more people who received peripheral stem cells survived, meaning that they were
# more likely to have time to develop GVHD
table(bone$survival_status, bone$stem_cell_source) %>%
  prop.table(margin = 2)

# proportion with GVHD
table(bone$acute_GvHD_II_III_IV, bone$stem_cell_source) %>%
  prop.table(margin = 2)

# what if we only look at people who survived?
survived <- filter(bone, survival_status == 0)
table(survived$acute_GvHD_II_III_IV, survived$stem_cell_source) %>%
  prop.table(margin = 2)
# note: there are only a few people included in this table

# could try to model GVHD based on stem cell source, adjusted for potential confounders

```




Another Secondary Analysis we looked at was the possible prediction and association of CD34 dosage and CD3 dosage on survival outcome. 

*Include a little research on the reasoning behind dosage levels
CD34+ = CD34+ cell dose per kg of recipient body weight (10^6/kg)
CD3 = CD3+ cell dose per kg of recipient body weight (10^8/kg)


Let's first look at a graph with the 2 different dosages and their effect on survival outcome
```{r, fig.height=7}
library(gridExtra)

p1 <- bone %>%
  ggplot(aes(x = CD34_x1e6_per_kg...CD34kgx10d6, y = CD3_x1e8_per_kg, color = as.factor(survival_status))) +
  scale_fill_discrete(name="Survival\nOutcome",
                         labels=c("Survival", "Death")) +   # Help is needed :(
  geom_point() +
  xlab("CD34+") +
  ylab("CD3") +
  ggtitle("Relationship between CD3 and CD34+")


p2 <- bone %>%
  ggplot(aes(x = CD34_x1e6_per_kg...CD34kgx10d6, y = CD3_x1e8_per_kg, color = as.factor(survival_status))) +
  geom_point() +
  scale_y_continuous(trans = "sqrt") +
  scale_x_continuous(trans = "sqrt") +
    xlab("CD34+") +
  ylab("CD3") +
  ggtitle("Relationship between CD3 and CD34+ (with sqrt transform)")


grid.arrange(p1, p2)
```


With the square root transform we are able to see a little bit of a trend.Just based off of a first glance, it looks like there were more death outcomes with fewer dosages of CD3 and CD34+

Let's look at a model with the 2 different dosages as predictors. These variables are in per kg of the recipients body weight, so we do not have to account for recipient body weight in our model. But maybe we can look at age of the recipient and see if it's a necessary predictor to add.We can also explore the ratio variable of the two dosages.

```{r}
CD <- bone %>%
  select(CD34_x1e6_per_kg...CD34kgx10d6, CD3_x1e8_per_kg, CD3_to_CD34_ratio, recipient_age, survival_status) %>%
  drop_na()
```

Let's first start with a simple model:
```{r}
simple.cd.mod <- glm(survival_status ~ CD34_x1e6_per_kg...CD34kgx10d6 + CD3_x1e8_per_kg,
                     data = CD,
                     family = binomial())

summary(simple.cd.mod)
```

We see that CD3 is a significant variable with a p-value of 0.0237
We also have an AIC of 245.48

Let's try to add recipient age into the model
```{r}
age.cd.mod <- glm(survival_status ~ CD34_x1e6_per_kg...CD34kgx10d6 + CD3_x1e8_per_kg + recipient_age,
                  data = CD,
                  family = binomial())

summary(age.cd.mod)
```

We get a slightly higher AIC value, and the p-values don't give us any indication that it is necessary to add into our mode. But let's check for confounding first. 

Age acting as a confounder on CD34+ and CD3 via 10% rule
```{r}
# CD34+
(-0.009609 - -0.001904) / (-0.009609) # No confounding

#CD3
(-0.120459 - -0.107012) / (-0.120459) # No confounding
```


Great no confounding, now let's quickly check for EMM for each doseage variable
```{r}
age.cd.mod.emm1 <- glm(survival_status ~ CD34_x1e6_per_kg...CD34kgx10d6 + CD3_x1e8_per_kg + recipient_age + recipient_age*CD34_x1e6_per_kg...CD34kgx10d6, 
                       data = CD,
                       family = binomial())

summary(age.cd.mod.emm1)


age.cd.mod.emm2 <- glm(survival_status ~ CD34_x1e6_per_kg...CD34kgx10d6 + CD3_x1e8_per_kg + recipient_age + recipient_age*CD3_x1e8_per_kg,
                       data = CD,
                       family = binomial())

summary(age.cd.mod.emm2)
```

Great, so significant interaction terms, so no effect measure modification.

So let's just stick with our original model, but first let's quickly look at a model with only the dosage ratio.


```{r}
dose.ratio.mod <- glm(survival_status ~ CD3_to_CD34_ratio,
                      data = CD,
                      family = binomial())

summary(dose.ratio.mod)
```
Not a very significant p-value and much a higher AIC value compared to our simple model.


Okay, now back to the original model
```{r}
summary(simple.cd.mod)
```


The resulting $\hat{\beta_1}$ is the log Odds Ratio of death occurring in those with any level of CD34+ dose versus those with one unit less of CD34+, holding CD3 dosage constant. We then find the odds ratio by taking the exponential of B1 finding:$\hat{OR} = e^{\hat{\beta_1}} = e^{-0.009609} = 0.990437 $.

Therefore, those with any level of CD34+ dose has 0.990437 times the odds of death compared to those with a CD34+ dose of one unit lower, on average, holding CD3 dosage constant, Which is not very significant of a value.


What if we look at a 10 unit change in dosage?
Looking at the effect of a 10-unit change of CD34+ dosage, we would have an odds ratio of:

$\hat{OR} = e^{10\hat{\beta_1}} = e^{(10*-0.009609)} =  0.9083823 $

So for those with any level of CD34+ dose have 0.9083823 times the odds of death compared to those with with a CD34+ dosage of 10 units lower, on average, holding CD3 constant, still not a huge difference.

```{r}
sd(CD$CD34_x1e6_per_kg...CD34kgx10d6)
```

----
My brain is spacing, but need to look up again how to interpret CD3 in this model... is it just exp(B2)?
---







Let's look at the association of survival outcome and each dosage alone
```{r, fig.width=6}

p1 <- CD %>%
  ggplot(aes(x = as.factor(survival_status), y = CD34_x1e6_per_kg...CD34kgx10d6, color = survival_status)) +
  geom_boxplot() +
  theme(legend.position = "none") +
  xlab("Survival Outcome") +
  ylab("CD34+ Dosage") +
  ggtitle("Association between CD34+ Dosage and Survival")


p2 <- CD %>%
  ggplot(aes(x = as.factor(survival_status), y = CD3_x1e8_per_kg, color = survival_status)) +
  geom_boxplot() +
  theme(legend.position = "none") +
  xlab("Survival Outcome") +
  ylab("CD3 Dosage") +
  ggtitle("Association between CD3 Dosage and Survival")


grid.arrange(p1,p2, nrow = 1)
```

There is definitely an association with each dosage and survival outcome.




---
Have some questions on this: what should we do here??
```{r}
# Mean of 5.38 which means that most times CD3 > CD34+
summary(CD$CD3_to_CD34_ratio)


# CD3 is in units of 10^6 while CD34+ is in units of 10^8... do we need to make them the same in order for analysis?
CD_new <- CD %>% 
  mutate(CD34 = CD34_x1e6_per_kg...CD34kgx10d6) %>%
  mutate(CD3 = CD3_x1e8_per_kg / 100) %>%
  mutate(CD3.to.CD34.newratio = CD3 / CD34)

head(CD_new)

```




Looking at models with each of the dosages as its own predictor
```{r}
CD34.mod <- glm(survival_status ~ CD34_x1e6_per_kg...CD34kgx10d6,
                data = CD,
                family = binomial())
summary(CD34.mod)


CD3.mod <- glm(survival_status ~ CD3_x1e8_per_kg,
                data = CD,
                family = binomial())
summary(CD3.mod)
```

The CD3 variable is much more significant by p-value in its own model than the CD34+ variable. 



---
Next looking at predicting survival outcome based on CD34+ and CD3 dosages:

We saw before we may be able to come up with a decent predictive model of survival based on CD3 and CD34+ dosage since we could see a slight association in this graph:
```{r}
bone %>%
  ggplot(aes(x = CD34_x1e6_per_kg...CD34kgx10d6, y = CD3_x1e8_per_kg, color = as.factor(survival_status))) +
  geom_point() +
  scale_y_continuous(trans = "sqrt") +
  scale_x_continuous(trans = "sqrt") +
    xlab("CD34+") +
  ylab("CD3") +
  ggtitle("Relationship between CD3 and CD34+ (with sqrt transform)")
```


Let's try out some various predictive models to see if there's one that predictos death better than others.
```{r}
# Model with both dosages
# simple.cd.mod

prediction <- ifelse(simple.cd.mod$fitted.values > 0.5, 1, 0) 
confusionMatrix(data = as.factor(prediction), 
                reference = as.factor(CD$survival_status),
                positive = "1")



# CD3 only model
# CD3.mod

prediction2 <- ifelse(CD3.mod$fitted.values > 0.5, 1, 0) 
confusionMatrix(data = as.factor(prediction2), 
                reference = as.factor(CD$survival_status),
                positive = "1")


# CD34+ only model
# CD34.mod 

prediction3 <- ifelse(CD34.mod$fitted.values > 0.5, 1, 0) 
confusionMatrix(data = as.factor(prediction3), 
                reference = as.factor(CD$survival_status),
                positive = "1")



# Ratio only model
# dose.ratio.mod

prediction4 <- ifelse(dose.ratio.mod$fitted.values > 0.5, 1, 0) 
confusionMatrix(data = as.factor(prediction4), 
                reference = as.factor(CD$survival_status),
                positive = "1")


```


